name: Update Codewars Stats

on:
  schedule:
    - cron: "0 0 * * *"  # Запуск раз в день (UTC)
  push:
    branches:
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies (jq, gnuplot)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gnuplot

      - name: Fetch Codewars Data & Update README (Bash version)
        run: |
          set -e
          USERNAME="alinachrks"
          URL="https://www.codewars.com/api/v1/users/${USERNAME}"

          # Получаем данные и проверяем статус запроса
          tempfile=$(mktemp)
          status=$(curl -s -o "$tempfile" -w "%{http_code}" "$URL")
          if [ "$status" -ne 200 ]; then
            echo "Ошибка при получении данных с Codewars API"
            exit 1
          fi

          # Извлекаем данные через jq
          rank=$(jq -r '.ranks.overall.name // "N/A"' "$tempfile")
          honor=$(jq -r '.honor // 0' "$tempfile")
          completed=$(jq -r '.codeChallenges.totalCompleted // 0' "$tempfile")
          current_date=$(date +"%Y-%m-%d")

          # Формируем новый объект статистики
          new_stat=$(printf '{"date": "%s", "rank": "%s", "honor": %s, "completed": %s}' "$current_date" "$rank" "$honor" "$completed")

          # Обновляем историю (создаём файл, если его ещё нет)
          if [ -f codewars_stats.json ]; then
              history=$(cat codewars_stats.json)
          else
              history="[]"
          fi
          updated_history=$(echo "$history" | jq --argjson new "$new_stat" '. + [$new]')
          echo "$updated_history" > codewars_stats.json

          # Готовим данные для построения графика
          jq -r '.[] | "\(.date) \(.honor) \(.completed)"' codewars_stats.json > codewars_data.txt

          # Строим график с помощью gnuplot
          gnuplot <<EOF
          set terminal png size 800,400
          set output "codewars_progress.png"
          set xdata time
          set timefmt "%Y-%m-%d"
          set format x "%Y-%m-%d"
          set xlabel "Дата"
          set ylabel "Количество"
          set title "Прогресс на Codewars"
          set grid
          plot "codewars_data.txt" using 1:2 with linespoints title "Очки чести", \
               "codewars_data.txt" using 1:3 with linespoints title "Решённые задачи"
EOF
          rm codewars_data.txt  # данные для графика не нужны в репозитории

          # Извлекаем последние данные для README
          latest_rank=$(jq -r '.[-1].rank' codewars_stats.json)
          latest_honor=$(jq -r '.[-1].honor' codewars_stats.json)
          latest_completed=$(jq -r '.[-1].completed' codewars_stats.json)

          cat <<EOF > README.md
          # Codewars Stats
          ![Codewars Progress](codewars_progress.png)

          - **Ранг:** $latest_rank
          - **Очки чести:** $latest_honor
          - **Решённые задачи:** $latest_completed
EOF

      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md codewars_stats.json codewars_progress.png
          git commit -m "Update Codewars stats" || echo "No changes to commit"
          git push

