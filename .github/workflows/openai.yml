name: OpenAI GitHub Summary

on:
  schedule:
    - cron: "0 0 * * 0"  # Ğ—Ğ°Ğ¿ÑƒÑĞº ĞºĞ°Ğ¶Ğ´Ğ¾Ğµ Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ Ğ² 00:00 UTC
  workflow_dispatch:  # ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ

permissions:
  contents: write

jobs:
  openai-task:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ”‘ Check OpenAI API Key
        run: |
          if [[ -z "${{ secrets.OPENAI_API_KEY }}" ]]; then
            echo "âŒ ERROR: OpenAI API key is missing in GitHub Secrets!"
            exit 1
          else
            echo "âœ… OpenAI API key is set."
          fi

      - name: ğŸ” Fetch GitHub Contributions
        run: |
          echo "ğŸš€ Fetching GitHub contributions for the past 7 days..."

          GH_USERNAME="alinachrks"
          REPO_NAME="alinachrks"
          SINCE=$(date -d "7 days ago" --iso-8601=seconds)

          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ñ‹ Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 7 Ğ´Ğ½ĞµĞ¹
          COMMITS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$GH_USERNAME/$REPO_NAME/commits?since=$SINCE" \
            | jq -r '[.[] | {date: .commit.author.date, message: .commit.message}] | @json')

          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ PR Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 7 Ğ´Ğ½ĞµĞ¹
          PULL_REQUESTS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/search/issues?q=author:$GH_USERNAME+type:pr+created:>$SINCE" \
            | jq -r '[.items[] | {title: .title, state: .state}] | @json')

          # Ğ•ÑĞ»Ğ¸ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¾Ğ² Ğ½ĞµÑ‚, Ğ·Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ "No commits"
          if [[ -z "$COMMITS" || "$COMMITS" == "[]" ]]; then
            COMMITS='[{"date": "N/A", "message": "No commits this week."}]'
          fi

          # Ğ•ÑĞ»Ğ¸ PR Ğ½ĞµÑ‚, Ğ·Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ "No PRs"
          if [[ -z "$PULL_REQUESTS" || "$PULL_REQUESTS" == "[]" ]]; then
            PULL_REQUESTS='[{"title": "No PRs this week", "state": "N/A"}]'
          fi

          echo "ğŸ“ Commits JSON: $COMMITS"
          echo "ğŸ“ Pull Requests JSON: $PULL_REQUESTS"

          # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² Ñ„Ğ°Ğ¹Ğ» JSON (Ğ¸Ğ·Ğ±ĞµĞ³Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼ Ñ ĞºĞ°Ğ²Ñ‹Ñ‡ĞºĞ°Ğ¼Ğ¸ Ğ¸ Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑĞ°Ğ¼Ğ¸ ÑÑ‚Ñ€Ğ¾Ğº)
          echo "{\"commits\": $COMMITS, \"pull_requests\": $PULL_REQUESTS}" > github_summary.json

      - name: ğŸ¤– Call OpenAI API
        run: |
          echo "ğŸš€ Calling OpenAI API..."
          RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d @github_summary.json)

          echo "ğŸ“ API Raw Response: $RESPONSE"

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ĞµÑÑ‚ÑŒ Ğ»Ğ¸ Ğ² Ğ¾Ñ‚Ğ²ĞµÑ‚Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°
          ERROR_MESSAGE=$(echo "$RESPONSE" | jq -r '.error.message // empty')
          if [[ -n "$ERROR_MESSAGE" ]]; then
            echo "âŒ OpenAI API request failed: $ERROR_MESSAGE"
            exit 1
          fi

          # Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
          SUMMARY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹
          if [[ -z "$SUMMARY" || "$SUMMARY" == "null" ]]; then
            echo "âš ï¸ OpenAI API returned an empty response. Skipping update."
            exit 0
          fi

          # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ
          TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S UTC")
          echo -e "### ğŸ§  AI Weekly Summary (Updated: $TIMESTAMP)\n\n$SUMMARY" > ai_summary.md
          echo "âœ… AI Summary successfully updated!"

      - name: âœï¸ Update README with AI Summary
        run: |
          echo "ğŸ“Œ Updating README.md..."
          awk '
            /<!-- START_AI_SUMMARY -->/ {print; while (getline < "ai_summary.md") print; found=1; next}
            /<!-- END_AI_SUMMARY -->/ {found=0}
            !found
          ' README.md > temp.md && mv temp.md README.md

      - name: ğŸ”„ Commit and Push Changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          git add ai_summary.md README.md
          if git diff --cached --quiet; then
            echo "âš¡ No changes to commit"
            exit 0
          fi

          git commit -m "ğŸ“ Auto-update AI Weekly Summary"
          
          # ĞŸÑ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ² Ğ¿Ñ€Ğ¸ push
          git pull --rebase
          git push

