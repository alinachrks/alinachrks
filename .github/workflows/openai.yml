name: OpenAI Automation

on:
  schedule:
    - cron: "0 0 * * 0"  # Ğ—Ğ°Ğ¿ÑƒÑĞº ĞºĞ°Ğ¶Ğ´Ğ¾Ğµ Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ Ğ² 00:00 UTC
  workflow_dispatch:  # ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ

permissions:
  contents: write

jobs:
  openai-task:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ“‚ Ensure AI Summary File Exists
        run: |
          if [ ! -f ai_summary.md ]; then
            echo "### ğŸ§  AI Weekly Summary" > ai_summary.md
            echo "No summary available yet." >> ai_summary.md
          fi

      - name: ğŸ¤– Call OpenAI API
        run: |
          echo "ğŸš€ Calling OpenAI API..."
          RESPONSE=$(curl -s -o response.json -w "%{http_code}" -X POST "https://api.openai.com/v1/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d '{
              "model": "gpt-4",
              "prompt": "Generate a short and informative summary of my GitHub contributions for this week.",
              "temperature": 0.7,
              "max_tokens": 150
            }')

          HTTP_STATUS=$(tail -n1 response.json)
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "âŒ OpenAI API request failed with status $HTTP_STATUS. Skipping update."
            exit 0
          fi

          SUMMARY=$(jq -r '.choices[0].text' response.json)

          if [[ -z "$SUMMARY" || "$SUMMARY" == "null" ]]; then
            echo "âš ï¸ OpenAI API returned an empty response. Skipping update."
            exit 0
          fi

          TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S UTC")
          echo -e "### ğŸ§  AI Weekly Summary (Updated: $TIMESTAMP)\n\n$SUMMARY" > ai_summary.md
          echo "âœ… AI Summary successfully updated!"

      - name: âœï¸ Update README with AI Summary
        run: |
          echo "ğŸ“Œ Updating README.md..."
          awk '
            /<!-- START_AI_SUMMARY -->/ {print; while (getline < "ai_summary.md") print; found=1; next}
            /<!-- END_AI_SUMMARY -->/ {found=0}
            !found
          ' README.md > temp.md && mv temp.md README.md


      - name: ğŸ”„ Commit and Push Changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          git add ai_summary.md README.md
          if git diff --cached --quiet; then
            echo "âš¡ No changes to commit"
            exit 0
          fi

          git commit -m "ğŸ“ Auto-update AI Weekly Summary"
          
          # ĞŸÑ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ² Ğ¿Ñ€Ğ¸ push
          git pull --rebase
          git push
